<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<project basedir="." default="package" name="MovieMetadataUpdater">
	<property environment="env" />

	<property name="target" value="target" />
	<property name="name" value="metadata-updater" />
	<property name="version" value="1.21" />
	<property name="jarname" value="${name}-${version}.jar" />
	<property name="launcher" value="MetadataTool" />
	<property name="mainClass" value="org.jdna.metadataupdater.MetadataUpdater" />

	<target name="all" depends="package" />

	<target name="package" depends="package-tool,package-plugin">
	</target>

	<target name="package-tool" depends="init,copyJars,makeJar,makeLaunch">
		<copy toDir="${target}/tool">
			<fileset dir="docs">
			</fileset>
		</copy>
		<copy toDir="${target}/tool/scrapers">
			<fileset dir="scrapers">
			</fileset>
		</copy>
		<zip destfile="${target}/${name}-${version}.zip">
			<fileset dir="${target}/tool">
			</fileset>
		</zip>
	</target>

	<target name="package-gwt" depends="package-tool">
		<copy toDir="${target}/gwt/">
			<fileset dir="bin" excludes="**/*.properties,/test/*,*.class" />
		</copy>

		<copy toDir="${target}/gwt/org/jdna/media/super/">
			<fileset dir="src" includes="org/jdna/media/**/I*.java,org/jdna/media/metadata/VideoMetaData.java,org/jdna/media/metadata/CastMember.java,org/jdna/media/metadata/ProviderInfo.java,org/jdna/media/metadata/VideoSearchResult.java,org/jdna/media/metadata/CoverResult.java">
				<exclude name="**/impl/**" />
			</fileset>
		</copy>

		<copy file="gwt/MediaApi.gwt.xml" todir="${target}/gwt/org/jdna/media/" />

		<jar destfile="${target}/gwt-${jarname}">
			<fileset dir="${target}/gwt/" />
		</jar>
	</target>

	<target name="package-plugin" depends="package-tool">
		<mkdir dir="${target}/sage" />
		<mkdir dir="${target}/sage/JARs" />

		<copy toDir="${target}/sage/JARs">
			<fileset dir="libs" excludes="Sage.*,nielm*,miglayout*" />
		</copy>

		<copy toDir="${target}/sage/JARs">
			<fileset file="${target}/tool/libs/${jarname}" />
		</copy>

		<copy toDir="${target}/sage/scrapers">
			<fileset dir="scrapers">
			</fileset>
		</copy>

		<echo file="${target}/sage/Sage.properties.metadataupdater">mediafile_metadata_parser_plugins=org.jdna.sage.MetadataUpdaterPlugin</echo>

		<zip destfile="${target}/${name}-plugin-${version}.zip" basedir="${target}/sage" />
	</target>


	<target name="copyJars">
		<copydir dest="${target}/tool/libs" src="libs" excludes="Sage*.jar">
		</copydir>
	</target>

	<target name="makeJar">
		<jar destfile="${target}/tool/libs/${jarname}">
			<fileset dir="bin">
			</fileset>
		</jar>
	</target>

	<target name="makeLaunch">
		<!-- build the classpath for the entries that we want -->
		<path id="project.classpath">
			<fileset dir="target/tool/libs" includes="*.jar">
			</fileset>
		</path>

		<!-- Convert project class path to string property -->
		<pathconvert property="mf.classpath" pathsep=" ">
			<path refid="project.classpath" />
			<chainedmapper>
				<flattenmapper />
				<regexpmapper from="(.*)" to="libs/\1" />
			</chainedmapper>
		</pathconvert>


		<jar destfile="${target}/tool/${launcher}.jar" whenempty="create">
			<manifest>
				<attribute name="Built-By" value="${user.name}" />
				<attribute name="Specification-Title" value="Batch Metadata Tools" />
				<attribute name="Specification-Version" value="${version}" />
				<attribute name="Specification-Vendor" value="jdna.org" />
				<attribute name="Implementation-Title" value="Batch Metadata Tools" />
				<attribute name="Implementation-Version" value="${version}" />
				<attribute name="Implementation-Vendor" value="jdna.org" />
				<attribute name="Main-Class" value="${mainClass}" />
				<attribute name="Class-Path" value="${mf.classpath}" />
			</manifest>
		</jar>
	</target>

	<target name="init">
		<delete dir="target" failonerror="false">
		</delete>
		<mkdir dir="target" />
		<copy includeemptydirs="false" todir="bin">
			<fileset dir="src" excludes="**/*.launch, **/*.java" />
		</copy>
	</target>

	<target name="clean">
		<delete dir="target" />
	</target>

	<target name="generate-constants">
		<xslt style="src/org/jdna/media/metadata/MetadataKey.xsl" in="src/org/jdna/media/metadata/MetadataKey.xml" out="src/org/jdna/media/metadata/MetadataKey.java">
		</xslt>
	</target>

	<target name="plugin-package">
		<echo>why is this called?</echo>
	</target>
</project>
